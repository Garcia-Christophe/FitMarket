# Image gradle avec le jdk17
image: gradle:7.3.3-jdk17-alpine

# Etapes du pipeline
stages:
  - âš™ï¸ Build
  - ğŸ§ª Test
  - ğŸš€ Deploy

# Build
build-job:
  stage: âš™ï¸ Build
  allow_failure: false
  script:
    - echo "VÃ©rification de la prÃ©sence des fichiers importants..."
    # Web
    - |
      if [ -f ./fitmarket/package.json ]; then
        echo "Web: Fichier ./fitmarket/package.json prÃ©sent."
      else
        echo "Web: Fichier ./fitmarket/package.json absent !"
        exit 1
      fi
    # Android
    - |
      if [ -f ./README.md ]; then
        echo "Web: Fichier ./README.md prÃ©sent."
      else
        echo "Web: Fichier ./README.md absent !"
        exit 1
      fi
    # Spring
    - |
      if [ -f ./back/fitmarket/src/main/java/com/m2/tiila/fitmarket/FitmarketApplication.java ]; then
        echo "Web: Fichier ./back/fitmarket/src/main/java/com/m2/tiila/fitmarket/FitmarketApplication.java prÃ©sent."
      else
        echo "Web: Fichier ./back/fitmarket/src/main/java/com/m2/tiila/fitmarket/FitmarketApplication.java absent !"
        exit 1
      fi
    # BDD
    - |
      if [ -f ./bdd/schema_bdd.sql ]; then
        echo "Web: Fichier ./bdd/schema_bdd.sql prÃ©sent."
      else
        echo "Web: Fichier ./bdd/schema_bdd.sql absent !"
        exit 1
      fi

# Test : Web
test-web:
  stage: ğŸ§ª Test
  allow_failure: false
  script:
    - echo "Tests de la partie Web..."
    - |
      if grep -q "port: 3000" ./fitmarket/vite.config.mjs; then
        echo "Le port de l'application web est bien 3000."
      else
        echo "Le port de l'application web n'est pas 3000 !"
        exit 1
      fi

# Test : Android
test-android:
  stage: ğŸ§ª Test
  allow_failure: false
  script:
    - echo "Tests de la partie Android..."
    - echo "Tests Android OK."

# Test : Spring
test-spring:
  stage: ğŸ§ª Test
  allow_failure: false
  script:
    - echo "Tests de la partie Spring..."
    - cd back/fitmarket
    - ./gradlew check
    - cd ../..

# Test : BDD
test-bdd:
  stage: ğŸ§ª Test
  allow_failure: false
  script:
    - echo "Tests de la partie BDD..."
    - echo "Tables de la BDD OK."

# Deploy
deploy-job:
  stage: ğŸš€ Deploy
  allow_failure: false
  environment: production
  script:
    - echo "DÃ©ploiement de l'application..."
    - echo "Application dÃ©ployÃ©e avec succÃ¨s."
